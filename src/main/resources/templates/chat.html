<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ÎèÑÏÑúÍ¥Ä Ï±óÎ¥á</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont;
            background: #f5f6f8;
            display: flex;
            justify-content: center;
        }

        .page-header {
            position: sticky;
            top: 0;
            background: #ffffff;
            z-index: 100;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .back-btn {
            text-decoration: none;
            font-size: 14px;
            color: #2563eb;
            font-weight: bold;
        }
        .page-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .message {
            max-width: 75%;
            padding: 10px 14px;
            margin-bottom: 10px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-line;
            word-break: break-word;
        }

        .message.user {
            align-self: flex-end;
            background-color: #2563eb;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.bot {
            align-self: flex-start;
            background-color: #e5e7eb;
            color: #111827;
            border-bottom-left-radius: 4px;
        }

        .messages {
            display: flex;
            flex-direction: column;
        }

        .clear-btn {
            margin-left: 6px;
            padding: 10px 12px;
            background: #9ca3af;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
        }

        .chat-container {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .chat-input {
            display: flex;
            padding: 12px;
            border-top: 1px solid #e5e7eb;
        }

        input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-size: 14px;
        }

        button {
            margin-left: 8px;
            padding: 10px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
        }
    </style>
</head>

<body>
<div class="chat-container">

    <div class="card">
        <div class="page-header">
            <h2>ü§ñ ÎèÑÏÑúÍ¥Ä Ï±óÎ¥á</h2>
            <a th:href="@{/qr/entry}" class="back-btn">‚Üê Ìôà ÌôîÎ©¥</a>
        </div>
    </div>

    <div id="messages" class="messages"></div>

    <div class="chat-input">
        <input id="input" type="text" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî‚Ä¶" />
        <button onclick="sendMessage()">Ï†ÑÏÜ°</button>
        <button class="clear-btn" onclick="clearChat()">Ï¥àÍ∏∞Ìôî</button>
    </div>

</div>

<script>
    const messages = document.getElementById("messages");
    const input = document.getElementById("input");
    const STORAGE_KEY = "library_chat_history";

    // Ï≤´ Î©îÏãúÏßÄ ÎßêÌíçÏÑ†
    document.addEventListener("DOMContentLoaded", () => {
        fetch("/api/chat/history")
            .then(res => res.json())
            .then(history => {

                if (!history || history.length === 0) {
                    addMessage(
                        `Ïù¥Î†áÍ≤å Î¨ºÏñ¥Î≥¥ÏÑ∏Ïöî üëá
                        ‚Ä¢ ÎÇ¥Í∞Ä ÎπåÎ¶∞ Ï±Ö ÏïåÎ†§Ï§ò
                        ‚Ä¢ Î∞òÎÇ© Í∏∞Ìïú Ïñ∏Ï†úÏïº?
                        ‚Ä¢ ÎåÄÏó¨ Ïó∞Ïû•ÌïòÍ≥† Ïã∂Ïñ¥
                        ‚Ä¢ ÎÇúÏÉùÏ≤òÏùå R ÏΩîÎî© & Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù ÏûàÏñ¥?`,
                        "bot", false);
                    return;
                }

                history.forEach(msg => {
                    addMessage(msg.message, msg.role, false);
                });
            })
            .catch(() => {
                addMessage("‚ö†Ô∏è Ïù¥Ï†Ñ ÎåÄÌôîÎ•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏñ¥Ïöî.", "bot", false);
            });
    });

    function sendMessage() {
        const text = input.value.trim();
        if (!text) return;

        // ÏÇ¨Ïö©Ïûê ÎßêÌíçÏÑ†
        addMessage(text, "user");
        input.value = "";

        // ü§ñ ÌÉÄÏù¥Ìïë ÎßêÌíçÏÑ†
        const typing = document.createElement("div");
        typing.className = "message bot";
        typing.innerText = "ÏûÖÎ†• Ï§ë‚Ä¶";
        messages.appendChild(typing);
        messages.scrollTop = messages.scrollHeight;

        fetch("/api/chat", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ message: text })
        })
            .then(res => res.json())
            .then(data => {
                typing.remove();                 // ÌÉÄÏù¥Ìïë Ï†úÍ±∞
                addMessage(data.reply, "bot");   // Î¥á ÏùëÎãµ
            })
            .catch(() => {
                typing.remove();
                addMessage("ÏÑúÎ≤ÑÏôÄ ÌÜµÏã† Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏñ¥Ïöî üò¢", "bot");
            });
    }

    function addMessage(text, type, save = true) {
        const div = document.createElement("div");
        div.className = "message " + type;
        div.innerText = text;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;

        if (save) {
            saveMessage(type, text);
        }
    }

    function saveMessage(role, text) {
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        history.push({ role, text });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    }

    function clearChat() {
        if (!confirm("ÎåÄÌôîÎ•º Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?")) return;

        fetch("/api/chat/history", { method: "DELETE" })
            .then(() => {
                messages.innerHTML = "";
                addMessage("ÎåÄÌôîÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§ üôÇ", "bot", false);
            });
    }

    // Enter ÌÇ§ Ï†ÑÏÜ°
    input.addEventListener("keydown", e => {
        if (e.key === "Enter") sendMessage();
    });

</script>


</body>
</html>
